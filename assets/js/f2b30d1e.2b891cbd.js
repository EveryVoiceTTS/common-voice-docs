"use strict";(self.webpackChunkcommon_voice_docs=self.webpackChunkcommon_voice_docs||[]).push([[962],{5743:function(e,t,a){a.r(t),a.d(t,{assets:function(){return d},contentTitle:function(){return s},default:function(){return m},frontMatter:function(){return o},metadata:function(){return p},toc:function(){return c}});var n=a(7462),l=a(3366),i=(a(7294),a(3905)),r=["components"],o={},s="Notes",p={unversionedId:"note",id:"note",title:"Notes",description:"Links",source:"@site/docs/note.md",sourceDirName:".",slug:"/note",permalink:"/common-voice-docs/docs/note",editUrl:"https://github.com/joanise/common-voice-docs/tree/main/docs/note.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Introduction to NRC's Common Voice project and fork",permalink:"/common-voice-docs/docs/intro"}},d={},c=[{value:"Links",id:"links",level:2},{value:"Tasks",id:"tasks",level:2},{value:"Auth0",id:"auth0",level:2},{value:"Whitelisting emails",id:"whitelisting-emails",level:3},{value:"Languages",id:"languages",level:2},{value:"How to Add a New Language",id:"how-to-add-a-new-language",level:3},{value:"Changing the Audio Format",id:"changing-the-audio-format",level:2},{value:"Available Lossless Audio Codecs",id:"available-lossless-audio-codecs",level:3},{value:"Available Formats",id:"available-formats",level:3},{value:"S3 File Name",id:"s3-file-name",level:2},{value:"S3proxy",id:"s3proxy",level:2},{value:"Why <code>You&#39;re on the staging server.</code>",id:"why-youre-on-the-staging-server",level:2},{value:"Microsoft Azure",id:"microsoft-azure",level:2},{value:"nextcloud",id:"nextcloud",level:2},{value:"File Changed so Far.",id:"file-changed-so-far",level:2}],u={toc:c};function m(e){var t=e.components,a=(0,l.Z)(e,r);return(0,i.kt)("wrapper",(0,n.Z)({},u,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"notes"},"Notes"),(0,i.kt)("h2",{id:"links"},"Links"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/common-voice/common-voice"},"Common Voice - Github")," Mozilla Common Voice, a platform for collecting speech donations in order to create public domain datasets for training voice recognition-related tools."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://chat.mozilla.org/#/room/#common-voice:mozilla.org"},"Matrix Chat")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://discourse.mozilla.org/c/voice/239"},"Discourse")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://auth0.com/"},"Auth0")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://www.npmjs.com/package/stream-transcoder"},"stream-transcoder.js")," Flexible media transcoding using FFmpeg. Stream media in and out - converting it on the fly.")),(0,i.kt)("h2",{id:"tasks"},"Tasks"),(0,i.kt)("p",null,"Hey Samuel, I mentioned I would pass on the info about what we\u2019re looking for.\nMy guess is you\u2019d want to be more involved in the ML part of the project no?\nThis is really a web development project."),(0,i.kt)("p",null,"Here\u2019s a description:\nWe\u2019re looking for a developer to create an instance of Mozilla Common Voice (",(0,i.kt)("a",{parentName:"p",href:"https://github.com/common-voice/common-voice"},"https://github.com/common-voice/common-voice"),") the stack is Docker, React, TypeScript, MySQL, S3.\nCommon Voice was set up to do crowd-source recording of audio, so there are some changes that would need to be made.\nNamely:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"we need the data to be unavailable to the public"),(0,i.kt)("li",{parentName:"ul"},"we need registration to be limited"),(0,i.kt)("li",{parentName:"ul"},"we need minor style and markup changes (ie taking away the language around Mozilla and adding some markup around the project)"),(0,i.kt)("li",{parentName:"ul"},"Common Voice currently collects audio in a lossy format (mp3), we need to change this to lossless\n16bit, 48k sample rate, lossless wav files"),(0,i.kt)("li",{parentName:"ul"},"Perhaps add some server-side scripting to automate signal processing/de-noising/backup"),(0,i.kt)("li",{parentName:"ul"},"Is it set up so that auth0 let\u2019s us define a list of email address or something that are whitelisted for signing up?\nThe recordings should also only be accessible to pre-defined sets of users.\nDo you have a sense of whether it will be easier to password protect the entire site or whether we could have tiers of access for particular recordings?")),(0,i.kt)("p",null,"Let me know if you have any questions though!"),(0,i.kt)("h2",{id:"auth0"},"Auth0"),(0,i.kt)("p",null,"Like it or not, you need a ",(0,i.kt)("a",{parentName:"p",href:"https://auth0.com/"},"Auth0")," account to get Common Voice to work.\nAdd the following lines to ",(0,i.kt)("inlineCode",{parentName:"p"},".env-local-docker")," which is locate at the root of the git repository."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'CV_AUTH0_DOMAIN="dev-24cisdir.us.auth0.com"\nCV_AUTH0_CLIENT_ID="<YOUR_ID>"\nCV_AUTH0_CLIENT_SECRET="<YOU_HAVE_A_SECRET>"\n')),(0,i.kt)("h3",{id:"whitelisting-emails"},"Whitelisting emails"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://auth0.com/docs/customize/rules"},"Auth0 Rules")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://auth0.com/docs/manage-users/user-accounts/manage-user-access-to-applications"},"Manage User Access to Applications")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/auth0/rules/tree/aeaf93bc058408e260192d0941a688963449d6be/src/rules"},"Rules examples")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/auth0/rules/blob/aeaf93bc058408e260192d0941a688963449d6be/src/rules/simple-user-whitelist-for-app.js"},"Whitelist for a Specific App")," Only allow access to users with whitelist email addresses on a specific app."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/auth0/rules/blob/aeaf93bc058408e260192d0941a688963449d6be/src/rules/simple-user-whitelist.js"},"Whitelist")," Only allow access to users with specific whitelist email addresses."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/auth0/rules/blob/aeaf93bc058408e260192d0941a688963449d6be/src/rules/simple-whitelist-on-a-connection.js"},"Whitelist on Specific Connection")," Only allow access to users coming from a whitelist on specific connection."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/auth0/rules/blob/aeaf93bc058408e260192d0941a688963449d6be/src/rules/simple-domain-whitelist.js"},"Email domain whitelist")," Only allow access to users with specific whitelist email domains."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/auth0/rules/blob/aeaf93bc058408e260192d0941a688963449d6be/src/rules/dropbox-whitelist.js"},"Whitelist on the cloud")," Determine access to users based on a whitelist of emails stored in Dropbox."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/auth0/rules/blob/aeaf93bc058408e260192d0941a688963449d6be/src/rules/add-country.js"},"Add country to the user profile")," Add a country attribute to the user based on their IP address."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/auth0/rules/blob/aeaf93bc058408e260192d0941a688963449d6be/src/rules/disable-social-signup.js"},"Disable social signups")," Disable signups from social connections."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/auth0/rules/blob/aeaf93bc058408e260192d0941a688963449d6be/src/rules/email-verified.js"},"Force email verification")," Only allow access to users with verified emails.")),(0,i.kt)("p",null,"Looking at ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/auth0/rules/blob/aeaf93bc058408e260192d0941a688963449d6be/src/rules/simple-user-whitelist-for-app.js"},"Whitelist for a Specific App")," seems to be promising."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"/**\n * @title Whitelist for a Specific App\n * @overview Only allow access to users with whitelist email addresses on a specific app\n * @gallery true\n * @category access control\n *\n * This rule will only allow access to users with specific email addresses on a specific app.\n *\n */\n\nfunction (user, context, callback) {\n\n  // Access should only be granted to verified users.\n  if (!user.email || !user.email_verified) {\n    return callback(new UnauthorizedError('Access denied.'));\n  }\n\n  // only enforce for NameOfTheAppWithWhiteList\n  // bypass this rule for all other apps\n  if(context.clientName !== 'NameOfTheAppWithWhiteList'){\n    return callback(null, user, context);\n  }\n\n  const whitelist = [ 'user1@example.com', 'user2@example.com' ]; // authorized users\n  const userHasAccess = whitelist.some(function (email) {\n    return email === user.email;\n  });\n\n  if (!userHasAccess) {\n    return callback(new UnauthorizedError('Access denied.'));\n  }\n\n  callback(null, user, context);\n}\n")),(0,i.kt)("h2",{id:"languages"},"Languages"),(0,i.kt)("p",null,"Can we limit the available languages?\n",(0,i.kt)("inlineCode",{parentName:"p"},"locales/all.json")," controls the available languages in the UI's drop down box.\nIt looks like the UI's language and the utterances' language are the same meaning that if you select English, you get the UI in English and you also get the utterances in English."),(0,i.kt)("h3",{id:"how-to-add-a-new-language"},"How to Add a New Language"),(0,i.kt)("p",null,"Since we haven't found a wait to have the UI in one language and the utterances in another language, we've decided to add a new language code for the utterances and copy the localizations of English to that new language."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Add ",(0,i.kt)("inlineCode",{parentName:"li"},"git")," & ",(0,i.kt)("inlineCode",{parentName:"li"},"str")," to ",(0,i.kt)("inlineCode",{parentName:"li"},"locales/all.json")," in order to get those new languages to show up in the UI's top-right dropdown box;"),(0,i.kt)("li",{parentName:"ul"},"We weren't sure what ",(0,i.kt)("inlineCode",{parentName:"li"},"locales/contributable.json")," is for so we also added ",(0,i.kt)("inlineCode",{parentName:"li"},"git")," & ",(0,i.kt)("inlineCode",{parentName:"li"},"str")," to it;"),(0,i.kt)("li",{parentName:"ul"},"In order to get the new language names to properly show up in the UI, we added their full names to ",(0,i.kt)("inlineCode",{parentName:"li"},"locales/native-names.json"),";"),(0,i.kt)("li",{parentName:"ul"},"Again, we weren't sure what ",(0,i.kt)("inlineCode",{parentName:"li"},"locales/translated.json")," is for and opted to add ",(0,i.kt)("inlineCode",{parentName:"li"},"git")," & ",(0,i.kt)("inlineCode",{parentName:"li"},"str")," to it;"),(0,i.kt)("li",{parentName:"ul"},"Under ",(0,i.kt)("inlineCode",{parentName:"li"},"server/data"),", we created two directories, ",(0,i.kt)("inlineCode",{parentName:"li"},"git/")," & ",(0,i.kt)("inlineCode",{parentName:"li"},"str/")," and populated them with some ",(0,i.kt)("inlineCode",{parentName:"li"},"utterances.txt"),";"),(0,i.kt)("li",{parentName:"ul"},"Finally, we want the UI to be in English even for ",(0,i.kt)("inlineCode",{parentName:"li"},"git")," & ",(0,i.kt)("inlineCode",{parentName:"li"},"str")," so we've decided to use the English localizations for them.  We create two directories, ",(0,i.kt)("inlineCode",{parentName:"li"},"git/")," & ",(0,i.kt)("inlineCode",{parentName:"li"},"str/")," under ",(0,i.kt)("inlineCode",{parentName:"li"},"web/locales/")," and simply copied the two files from ",(0,i.kt)("inlineCode",{parentName:"li"},"en/"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"cross-locale.ftl")," & ",(0,i.kt)("inlineCode",{parentName:"li"},"messages.ftl")," to each of the new languages' directory.")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"cp en/* git/\ncp en/* str/\n")),(0,i.kt)("h2",{id:"changing-the-audio-format"},"Changing the Audio Format"),(0,i.kt)("p",null,"To change the audio codec, the format & the sample rate, you have to add the following lines to ",(0,i.kt)("inlineCode",{parentName:"p"},".env-local-docker")," which is located at the root of the repository."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"CV_TRANSCODE_CODEC='pcm_s16le'\nCV_TRANSCODE_FORMAT='wav'\nCV_TRANSCODE_SAMPLE_RATE='44100'\n")),(0,i.kt)("h3",{id:"available-lossless-audio-codecs"},"Available Lossless Audio Codecs"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'ffmpeg -codecs |& grep ".EA..S"\n')),(0,i.kt)("p",null,"or"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'docker container exec -it web ffmpeg -codecs |& grep ".EA..S"\n')),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"docker container exec -it web ffmpeg -codecs \\\n |& grep \".EA..S\" \\\n | sed -e 's| \\([^ ]\\+\\) \\([^ ]\\+\\) \\+\\(.\\+\\)|\\1\\t\\2\\t\\3|' \\\n | tabulate --sep $'\\t' --format pipe\n")),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Attributes"),(0,i.kt)("th",{parentName:"tr",align:null},"Name"),(0,i.kt)("th",{parentName:"tr",align:null},"Description"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"DEA..S"),(0,i.kt)("td",{parentName:"tr",align:null},"alac"),(0,i.kt)("td",{parentName:"tr",align:null},"ALAC (Apple Lossless Audio Codec)")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"DEA.LS"),(0,i.kt)("td",{parentName:"tr",align:null},"dts"),(0,i.kt)("td",{parentName:"tr",align:null},"DCA (DTS Coherent Acoustics) (decoders: dca ) (encoders: dca )")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"DEA..S"),(0,i.kt)("td",{parentName:"tr",align:null},"flac"),(0,i.kt)("td",{parentName:"tr",align:null},"FLAC (Free Lossless Audio Codec)")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"DEA..S"),(0,i.kt)("td",{parentName:"tr",align:null},"mlp"),(0,i.kt)("td",{parentName:"tr",align:null},"MLP (Meridian Lossless Packing)")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"DEA..S"),(0,i.kt)("td",{parentName:"tr",align:null},"pcm_f32be"),(0,i.kt)("td",{parentName:"tr",align:null},"PCM 32-bit floating point big-endian")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"DEA..S"),(0,i.kt)("td",{parentName:"tr",align:null},"pcm_f32le"),(0,i.kt)("td",{parentName:"tr",align:null},"PCM 32-bit floating point little-endian")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"DEA..S"),(0,i.kt)("td",{parentName:"tr",align:null},"pcm_f64be"),(0,i.kt)("td",{parentName:"tr",align:null},"PCM 64-bit floating point big-endian")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"DEA..S"),(0,i.kt)("td",{parentName:"tr",align:null},"pcm_f64le"),(0,i.kt)("td",{parentName:"tr",align:null},"PCM 64-bit floating point little-endian")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"DEA..S"),(0,i.kt)("td",{parentName:"tr",align:null},"pcm_s16be"),(0,i.kt)("td",{parentName:"tr",align:null},"PCM signed 16-bit big-endian")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"DEA..S"),(0,i.kt)("td",{parentName:"tr",align:null},"pcm_s16be_planar"),(0,i.kt)("td",{parentName:"tr",align:null},"PCM signed 16-bit big-endian planar")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"DEA..S"),(0,i.kt)("td",{parentName:"tr",align:null},"pcm_s16le"),(0,i.kt)("td",{parentName:"tr",align:null},"PCM signed 16-bit little-endian")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"DEA..S"),(0,i.kt)("td",{parentName:"tr",align:null},"pcm_s16le_planar"),(0,i.kt)("td",{parentName:"tr",align:null},"PCM signed 16-bit little-endian planar")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"DEA..S"),(0,i.kt)("td",{parentName:"tr",align:null},"pcm_s24be"),(0,i.kt)("td",{parentName:"tr",align:null},"PCM signed 24-bit big-endian")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"DEA..S"),(0,i.kt)("td",{parentName:"tr",align:null},"pcm_s24daud"),(0,i.kt)("td",{parentName:"tr",align:null},"PCM D-Cinema audio signed 24-bit")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"DEA..S"),(0,i.kt)("td",{parentName:"tr",align:null},"pcm_s24le"),(0,i.kt)("td",{parentName:"tr",align:null},"PCM signed 24-bit little-endian")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"DEA..S"),(0,i.kt)("td",{parentName:"tr",align:null},"pcm_s24le_planar"),(0,i.kt)("td",{parentName:"tr",align:null},"PCM signed 24-bit little-endian planar")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"DEA..S"),(0,i.kt)("td",{parentName:"tr",align:null},"pcm_s32be"),(0,i.kt)("td",{parentName:"tr",align:null},"PCM signed 32-bit big-endian")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"DEA..S"),(0,i.kt)("td",{parentName:"tr",align:null},"pcm_s32le"),(0,i.kt)("td",{parentName:"tr",align:null},"PCM signed 32-bit little-endian")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"DEA..S"),(0,i.kt)("td",{parentName:"tr",align:null},"pcm_s32le_planar"),(0,i.kt)("td",{parentName:"tr",align:null},"PCM signed 32-bit little-endian planar")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"DEA..S"),(0,i.kt)("td",{parentName:"tr",align:null},"pcm_s64be"),(0,i.kt)("td",{parentName:"tr",align:null},"PCM signed 64-bit big-endian")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"DEA..S"),(0,i.kt)("td",{parentName:"tr",align:null},"pcm_s64le"),(0,i.kt)("td",{parentName:"tr",align:null},"PCM signed 64-bit little-endian")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"DEA..S"),(0,i.kt)("td",{parentName:"tr",align:null},"pcm_s8"),(0,i.kt)("td",{parentName:"tr",align:null},"PCM signed 8-bit")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"DEA..S"),(0,i.kt)("td",{parentName:"tr",align:null},"pcm_s8_planar"),(0,i.kt)("td",{parentName:"tr",align:null},"PCM signed 8-bit planar")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"DEA..S"),(0,i.kt)("td",{parentName:"tr",align:null},"pcm_u16be"),(0,i.kt)("td",{parentName:"tr",align:null},"PCM unsigned 16-bit big-endian")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"DEA..S"),(0,i.kt)("td",{parentName:"tr",align:null},"pcm_u16le"),(0,i.kt)("td",{parentName:"tr",align:null},"PCM unsigned 16-bit little-endian")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"DEA..S"),(0,i.kt)("td",{parentName:"tr",align:null},"pcm_u24be"),(0,i.kt)("td",{parentName:"tr",align:null},"PCM unsigned 24-bit big-endian")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"DEA..S"),(0,i.kt)("td",{parentName:"tr",align:null},"pcm_u24le"),(0,i.kt)("td",{parentName:"tr",align:null},"PCM unsigned 24-bit little-endian")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"DEA..S"),(0,i.kt)("td",{parentName:"tr",align:null},"pcm_u32be"),(0,i.kt)("td",{parentName:"tr",align:null},"PCM unsigned 32-bit big-endian")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"DEA..S"),(0,i.kt)("td",{parentName:"tr",align:null},"pcm_u32le"),(0,i.kt)("td",{parentName:"tr",align:null},"PCM unsigned 32-bit little-endian")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"DEA..S"),(0,i.kt)("td",{parentName:"tr",align:null},"pcm_u8"),(0,i.kt)("td",{parentName:"tr",align:null},"PCM unsigned 8-bit")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"DEA..S"),(0,i.kt)("td",{parentName:"tr",align:null},"s302m"),(0,i.kt)("td",{parentName:"tr",align:null},"SMPTE 302M")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"DEA..S"),(0,i.kt)("td",{parentName:"tr",align:null},"truehd"),(0,i.kt)("td",{parentName:"tr",align:null},"TrueHD")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"DEA..S"),(0,i.kt)("td",{parentName:"tr",align:null},"tta"),(0,i.kt)("td",{parentName:"tr",align:null},"TTA (True Audio)")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"DEA.LS"),(0,i.kt)("td",{parentName:"tr",align:null},"wavpack"),(0,i.kt)("td",{parentName:"tr",align:null},"WavPack (encoders: wavpack libwavpack )")))),(0,i.kt)("h3",{id:"available-formats"},"Available Formats"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"ffmpeg -formats\n")),(0,i.kt)("p",null,"or"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"docker container exec -it web ffmpeg -formats\n")),(0,i.kt)("h2",{id:"s3-file-name"},"S3 File Name"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"server/src/lib/clip.ts"),":",(0,i.kt)("inlineCode",{parentName:"p"},"saveClip()"),"\nSaving the audio content on S3."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"   const { client_id, headers } = request;\n   const sentenceId = headers.sentence_id as string;\n\n   const folder = client_id + '/';\n   const filePrefix = sentenceId;\n   const clipFileName = folder + filePrefix + '.' + config.TRANSCODE.FORMAT;\n\n   await this.s3\n     .upload({\n       Bucket: config.CLIP_BUCKET_NAME,\n       Key: clipFileName,\n       Body: audioOutput,\n     })\n     .promise();\n")),(0,i.kt)("p",null,"I think utterances are identified by a ",(0,i.kt)("inlineCode",{parentName:"p"},"client_id + sentenceId"),".\nThe recording are saved in a bucket and there metadata in a database.\n",(0,i.kt)("inlineCode",{parentName:"p"},"this.model.db.clipExists(client_id, sentenceId)")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"    await this.model.saveClip({\n      client_id: client_id,\n      localeId: sentence.locale_id,\n      original_sentence_id: sentenceId,\n      path: clipFileName,\n      sentence: sentence.text,\n    });\n")),(0,i.kt)("h2",{id:"s3proxy"},"S3proxy"),(0,i.kt)("p",null,"What is stored in our S3 proxy.\nThis is similar to ",(0,i.kt)("inlineCode",{parentName:"p"},"ls"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"curl http://127.0.0.1:9001/common-voice-clips \\\n| xmllint --format -\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'<?xml version="1.0" encoding="UTF-8"?>\n<ListBucketResult xmlns="http://s3.amazonaws.com/doc/2006-03-01/">\n  <Name>common-voice-clips</Name>\n  <Prefix/>\n  <MaxKeys>1000</MaxKeys>\n  <Marker/>\n  <IsTruncated>false</IsTruncated>\n  <Contents>\n    <Key>18f74bcf-210c-43e6-b443-78248399c0ce/</Key>\n    <LastModified>2022-01-18T19:28:13Z</LastModified>\n    <ETag>"d41d8cd98f00b204e9800998ecf8427e"</ETag>\n    <Size>4096</Size>\n    <StorageClass>STANDARD</StorageClass>\n    <Owner>\n      <ID>75aa57f09aa0c8caeab4f8c24e99d10f8e7faeebf76c078efc7c6caea54ba06a</ID>\n      <DisplayName>CustomersName@amazon.com</DisplayName>\n    </Owner>\n  </Contents>\n  <Contents>\n    <Key>18f74bcf-210c-43e6-b443-78248399c0ce/00003ee1748579223ce314d00265913ba19835024b6e536f0d425230da27a629.mp3</Key>\n    <LastModified>2022-01-18T19:25:38Z</LastModified>\n    <ETag>"31c67dbfbb001f63468af54c228b77b6"</ETag>\n    <Size>35901</Size>\n    <StorageClass>STANDARD</StorageClass>\n    <Owner>\n      <ID>75aa57f09aa0c8caeab4f8c24e99d10f8e7faeebf76c078efc7c6caea54ba06a</ID>\n      <DisplayName>CustomersName@amazon.com</DisplayName>\n    </Owner>\n  </Contents>\n</ListBucketResult>\n')),(0,i.kt)("p",null,"Retrieve a file and check what file type it is."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"curl http://127.0.0.1:9001/common-voice-clips/18f74bcf-210c-43e6-b443-78248399c0ce/00003ee1748579223ce314d00265913ba19835024b6e536f0d425230da27a629.mp3 \\\n| file -\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"/dev/stdin: Audio file with ID3 version 2.4.0, contains:MPEG ADTS, layer III, v1, 48 kbps, 32 kHz, Monaural\n")),(0,i.kt)("h2",{id:"why-youre-on-the-staging-server"},"Why ",(0,i.kt)("inlineCode",{parentName:"h2"},"You're on the staging server.")),(0,i.kt)("p",null,"Originating from ",(0,i.kt)("inlineCode",{parentName:"p"},"web/src/components/layout/layout.tsx"),"\nIt uses ",(0,i.kt)("inlineCode",{parentName:"p"},"web/src/utility.ts:isProduction()")," which simply check if the ",(0,i.kt)("inlineCode",{parentName:"p"},"window.location.origin === URLS.HTTP_ROOT")," where ",(0,i.kt)("inlineCode",{parentName:"p"},"URLS.HTTP_ROOT")," is ",(0,i.kt)("inlineCode",{parentName:"p"},"https://commonvoice.mozilla.org"),"."),(0,i.kt)("h2",{id:"microsoft-azure"},"Microsoft Azure"),(0,i.kt)("p",null,"Can we use Microsoft Azure instead of AWS S#?"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://devblogs.microsoft.com/cse/2016/05/22/access-azure-blob-storage-from-your-apps-using-s3-api/"},"Access Azure Blob Storage from Your Apps using S3 Java API")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/gaul/s3proxy"},"S3Proxy")," S3Proxy implements the S3 API and proxies requests, enabling several use cases:",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"translation from S3 to Backblaze B2, EMC Atmos, Google Cloud, Microsoft Azure, and OpenStack Swift"),(0,i.kt)("li",{parentName:"ul"},"testing without Amazon by using the local filesystem"),(0,i.kt)("li",{parentName:"ul"},"extension via middlewares"),(0,i.kt)("li",{parentName:"ul"},"embedding into Java applications"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/gaul/s3proxy/wiki/Storage-backend-examples#azure-blob"},"S3Proxy - Storage backend examples Azure Blob"))),(0,i.kt)("p",null,"The common voice docker stack uses S3Proxy.\nIf we can configure S3Proxy to ingest the current S3 requests from the server and send them to Microsoft Azure, that would solve our connection problem.\nIt looks like the S3Proxy container is quite configurable with ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/gaul/s3proxy/blob/master/Dockerfile"},"environment variables"),"."),(0,i.kt)("p",null,"Here's what the S3Proxy command looks like:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"docker container exec -it s3proxy cat run-docker-container.sh\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'#!/bin/sh\n\nexec java \\\n    -DLOG_LEVEL="${LOG_LEVEL}" \\\n    -Ds3proxy.endpoint="${S3PROXY_ENDPOINT}" \\\n    -Ds3proxy.virtual-host="${S3PROXY_VIRTUALHOST}" \\\n    -Ds3proxy.authorization="${S3PROXY_AUTHORIZATION}" \\\n    -Ds3proxy.identity="${S3PROXY_IDENTITY}" \\\n    -Ds3proxy.credential="${S3PROXY_CREDENTIAL}" \\\n    -Ds3proxy.cors-allow-all="${S3PROXY_CORS_ALLOW_ALL}" \\\n    -Ds3proxy.cors-allow-origins="${S3PROXY_CORS_ALLOW_ORIGINS}" \\\n    -Ds3proxy.cors-allow-methods="${S3PROXY_CORS_ALLOW_METHODS}" \\\n    -Ds3proxy.cors-allow-headers="${S3PROXY_CORS_ALLOW_HEADERS}" \\\n    -Ds3proxy.ignore-unknown-headers="${S3PROXY_IGNORE_UNKNOWN_HEADERS}" \\\n    -Djclouds.provider="${JCLOUDS_PROVIDER}" \\\n    -Djclouds.identity="${JCLOUDS_IDENTITY}" \\\n    -Djclouds.credential="${JCLOUDS_CREDENTIAL}" \\\n    -Djclouds.endpoint="${JCLOUDS_ENDPOINT}" \\\n    -Djclouds.region="${JCLOUDS_REGION}" \\\n    -Djclouds.regions="${JCLOUDS_REGIONS}" \\\n    -Djclouds.keystone.version="${JCLOUDS_KEYSTONE_VERSION}" \\\n    -Djclouds.keystone.scope="${JCLOUDS_KEYSTONE_SCOPE}" \\\n    -Djclouds.keystone.project-domain-name="${JCLOUDS_KEYSTONE_PROJECT_DOMAIN_NAME}" \\\n    -Djclouds.filesystem.basedir="/data" \\\n    -jar /opt/s3proxy/s3proxy \\\n    --properties /dev/null\n')),(0,i.kt)("p",null,"If we start from ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/gaul/s3proxy/wiki/Storage-backend-examples#azure-blob"},"S3Proxy - Storage backend examples Azure Blob")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"s3proxy.endpoint=http://127.0.0.1:8080\ns3proxy.authorization=aws-v2-or-v4\ns3proxy.identity=local-identity\ns3proxy.credential=local-credential\njclouds.provider=azureblob\njclouds.identity=xxxxxxxxx\njclouds.credential=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n")),(0,i.kt)("p",null,"and the common voice's ",(0,i.kt)("inlineCode",{parentName:"p"},"docker-compose.yaml"),", we can probably set it up to use Microsoft Azure."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"  s3proxy:\n    environment:\n      - S3PROXY_AUTHORIZATION=none\n")),(0,i.kt)("p",null,"We need to set a minimum of environment variables."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"  s3proxy:\n    environment:\n      - S3PROXY_ENDPOINT=http://0.0.0.0:80\n      - S3PROXY_AUTHORIZATION=aws-v2-or-v4\n      - S3PROXY_IDENTITY=local-identity\n      - S3PROXY_CREDENTIAL=local-credential\n      - JCLOUDS_PROVIDER=azureblob\n      - JCLOUDS_IDENTITY=xxxxxxxx\n      - JCLOUDS_CREDENTIAL=yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy\n")),(0,i.kt)("h2",{id:"nextcloud"},"nextcloud"),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://code.blogs.iiidefix.net/posts/webdav-with-curl/"},"WEBDAV WITH CURL")),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://stackoverflow.com/a/26676902"},"list files/folders in owncloud with php curl")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'curl -X PROPFIND -u user:password "http://yourserver.com/owncloud/remote.php/webdav/"\n')),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"PROPFIND = get the list of files/folders"),(0,i.kt)("li",{parentName:"ul"},"MKCOL = create folder"),(0,i.kt)("li",{parentName:"ul"},"DELETE = delete file/folder"),(0,i.kt)("li",{parentName:"ul"},"MOVE = move or rename a file or folder"),(0,i.kt)("li",{parentName:"ul"},"PUT = upload file"),(0,i.kt)("li",{parentName:"ul"},"GET = download file")),(0,i.kt)("p",null,"webdav.list_files"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'<?xml version="1.0"?>\n<a:propfind xmlns:a="DAV:">\n<a:prop><a:resourcetype/></a:prop>\n</a:propfind>\n')),(0,i.kt)("p",null,"Note that the order of the following command is crutial, or so it seems."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'curl \\\n  -u 2c523d8d-449f-4176-bb05-SSSSSSSSSSSS:cPmzY-ZZZZZ-PD8dd-SSSSS-2DC3F \\\n  -i \\\n  -X PROPFIND \\\n  https://nextcloud.nrc-cnrc.gc.ca/remote.php/dav/files/2c523d8d-449f-4176-bb05-SSSSSSSSSSSS/CommonVoice/ \\\n  --upload-file - \\\n  -H "Depth: 1" \\\n  < webdav.list_files\n')),(0,i.kt)("h2",{id:"file-changed-so-far"},"File Changed so Far."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"server/src/lib/api.ts")," ",(0,i.kt)("inlineCode",{parentName:"li"},"saveAvatarClip()")," which I don't think I should've change because it's probably not related to the recordings."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"server/src/lib/bucket.ts")," ",(0,i.kt)("inlineCode",{parentName:"li"},"getRandomClips()")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"server/src/lib/clip.ts"))))}m.isMDXComponent=!0}}]);